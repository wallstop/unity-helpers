# Improvement Plan (2025-11-26)

## Priority 2 — Maintainability & Developer Experience

### 5. Split `UnityExtensions` into focused modules *(In Progress)*

- **Problem**: `Runtime/Core/Extension/UnityExtensions.cs` is still a multi-thousand-line catch‑all (UI helpers, bounds/rect utilities, pooling helpers, etc.). Only the geometry block had been extracted, so most changes still collided in the root file and new helpers kept landing there by default.
- **2025-11-26 Progress**: Started carving the file into targeted partials by moving all bounds/rect/camera helpers into `UnityExtensions.Bounds.cs`. This includes center-point helpers, Rect↔Bounds conversions, RectTransform world rects, orthographic camera bounds, and the `BoundsInt`/`Bounds` aggregation utilities, reducing the root file by ~200 lines and isolating pooling dependencies. Followed up by extracting the UI helpers (`Slider.SetColors`, RectTransform offset setters) into `UnityExtensions.UI.cs`, and physics/collider helpers (`Rigidbody2D.Stop`, `Collider2D.IsCircleFullyContained`, `PolygonCollider2D.Invert`) into `UnityExtensions.Physics.cs`, keeping IMGUI and physics logic out of the geometry-heavy root. Remaining work: move the overlap/containment predicates and grid enumeration helpers into their own partial.
- **2025-11-27 Progress**: Finished isolating the overlap/containment predicates by leaving `UnityExtensions.Containment.cs` focused solely on fast `Bounds`/`BoundsInt` predicates and extracted the grid traversal helpers (`WithPadding`, `AllFastPositionsWithin`, `IsOnEdge2D`, etc.) into the new `UnityExtensions.GridTraversal.cs` partial. This removes the last of the grid enumeration logic from the containment block and keeps grid iteration utilities discoverable alongside other discrete-grid APIs.
- **2025-11-27 Progress (cont.)**: Split the monolithic `UnityExtensions.Grid.cs` into `UnityExtensions.GridConvexHull.cs` (all builders + pooled helpers) and `UnityExtensions.GridHullDiagnostics.cs` (Vector2/FastVector3Int containment + orientation helpers), and relocated the Vector2 concave entry points into `UnityExtensions.GridConcaveHull.cs`. This keeps convex builders, diagnostics, and concave wrappers isolated so edits no longer collide.
- **2025-11-28 Progress**: Split the original 80 KB `UnityExtensions.GridConcaveHull.cs` into four targeted partials: `GridConcaveHullKnn` (k-NN builders + helper sorts), `GridConcaveHullEdgeSplit` (edge-split + Vector2 variants), `GridConcaveHullDiagnostics` (axis-corner repair, point-in-hull, geometry helpers), and `GridConcaveHullLineDivision` (legacy line-divider). The dispatcher `GridConcaveHull.cs` now only routes strategies, eliminating the previous merge hotspot.
- **2025-11-28 Progress (cont.)**: Retired the unstable line-division strategy by stubbing `BuildConcaveHull` with a `NotSupportedException` and new `[Obsolete]` attribute, and added regression tests for the diagnostics helpers (`IsPositionInside` for both Vector2 and grid variants) to guard the newly split partial boundaries.
- **Next Step**: Add focused tests that exercise the edge-split QuadTree flow (nearest-neighbor selection + angle thresholds) and consider fully removing the legacy line-division entry point from public docs once downstream packages stop referencing it.
- **Impact**: Smaller diffs, easier reviews, clearer ownership of complex helpers, and fewer merge conflicts when multiple teams touch `UnityExtensions`.

### 8. Concave Hull Parity & Regression Guardrails *(In Progress)*

- **Problem**: The grid and gridless concave hull entry points had drifted apart. Edge-split builds occasionally dropped interior “elbow” vertices (staircase/horseshoe/serpentine shapes) while the gridless FastVector path stayed sparse but inconsistent. Tight angle thresholds needed to fall back to the convex hull, yet loose thresholds and k-NN builds must retain axis corners. Randomized regression suites (`UnityExtensionsComprehensiveTests`) failed as the implementations diverged.
- **2025-11-27 Progress**: Added a shared axis-corner repair pass that can reinsert missing concave vertices using only the original input samples, deduplicates the resulting hull, and is gated so strict edge-split configurations stay convex while k-NN / high-angle builds regain their elbows. Added diagnostic/data-driven tests in `UnityExtensionsGridConcaveHullTests` plus changelog notes documenting the behavior change.
- **Next Steps**:
  1. Extend the randomized regression harness (large point clouds & multi-seed runs) to capture hull diffs for each seed and dump failing hulls to fail-safe assets, making future mismatches easier to debug.
  2. Perf-profile the axis-corner repair on large data sets (≥10k points) and add counters to ensure the repair doesn’t exceed the convex hull size or introduce duplicate vertices under heavy load.
  3. Port the corner diagnostics to the FastVector (gridless) suites so both entry points log actionable hull snapshots when regressions reappear.
- **Impact**: Keeps grid and gridless concave hulls behaviorally aligned, prevents sparse concave inputs from regressing, and provides reproducible diagnostics when random-cloud suites fail.
