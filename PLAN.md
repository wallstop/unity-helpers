# Improvement Plan (2025-11-26)

## Priority 2 ‚Äî Maintainability & Developer Experience

### üî• High Priority Investigation ‚Äî Concave Hull Repair Loop Regression *(New)*

- **What happened**: The latest round of concave-hull work introduced synthetic ‚Äúaxis path‚Äù fallbacks that insert corners not present in the original data. In practice this created situations where the repair pass keeps splicing in alternating corners (A‚ÜíB‚ÜíA‚Ä¶) without ever exhausting the loop, manifesting as test runs that never finish (CI timeout after 10‚Äì15 minutes). The first sign was the large-sample repair test (`ConcaveHullRepairMetricsRemainBoundedOnLargeSamples`) stalling even though previous builds completed in ~12s.
- **Current hypothesis**: The new `TrySynthesizeAxisPath`/`InsertAxisPathWaypoints` helpers can inject corners outside the source point set. When `InsertMissingAxisCorners` runs again, those synthetic points fail the ‚Äúpoint set contains candidate‚Äù guard, so we attempt to synthesize another path, effectively oscillating forever. The regression also aligns with the switch to always running `RepairVector2Hull` after the Vector2 entry points, so both grid and gridless paths hit the offending code.
- **Immediate actions**:
  1. Reproduce locally by running `ConcaveHullRepairMetricsRemainBoundedOnLargeSamples` in isolation with verbose logging to confirm the looping behavior and capture the sequence of injected corners.
  2. Temporarily disable synthetic-path insertion (fall back to `pointSet.Contains`-only logic) and rerun the large-sample + hull parity suites to verify the loop disappears.
  3. Once confirmed, design a safer fallback (e.g., expand the point set with a bounded axis walk derived from the actual input grid) or drop the feature entirely if it isn‚Äôt required for production data.
  4. Add a watchdog assertion inside `InsertMissingAxisCorners` (or the large-sample test) to fail fast when the loop exceeds N iterations so future regressions don‚Äôt just hang CI.
- **Owner**: Geometry/concave-hull maintainers (current on-call agent)
- **Timeline**: Begin investigation immediately; aim for a fix (or revert) within the next working day to unblock CI.
- **2025-11-29 Progress**: Installed an iteration watchdog inside `InsertMissingAxisCorners` (Guard = `max(1024, uniquePointCount * 4)`) so the repair loop now throws with the captured `ConcaveHullRepairStats` snapshot instead of spinning forever. Waiting on a repro run of `ConcaveHullRepairMetricsRemainBoundedOnLargeSamples` with `ENABLE_CONCAVE_HULL_STATS` enabled to capture the offending axis path sequence before proceeding to the temporary feature toggle.
- **2025-11-29 Progress (cont.)**: Fixed the axis-path insertion loop by only marking the repair pass as ‚Äúprogress‚Äù when a new waypoint is actually injected and by tracking axis-corner inserts inside the hull set. Added an idempotence regression test so running the repair twice on an already axis-aligned hull remains a no-op, preventing the duplicate explosions that previously tripped the watchdog and `DuplicateRemovals` counter.
- **2025-11-29 Progress (cont. 2)**: Prevented candidate reconnection from spamming duplicates by having `InsertPathAfterIndex` skip waypoints already present in the hull and teaching `TryFindAxisPath` to fall back to a straight axis connection for lattice-aligned candidates. This keeps the large-sample repair stats bounded (duplicate removals now stay at 0) and unblocks the Vector2 horseshoe tests, which once again regain their missing interior corners.

### 5. Split `UnityExtensions` into focused modules *(In Progress)*

- **Problem**: `Runtime/Core/Extension/UnityExtensions.cs` is still a multi-thousand-line catch‚Äëall (UI helpers, bounds/rect utilities, pooling helpers, etc.). Only the geometry block had been extracted, so most changes still collided in the root file and new helpers kept landing there by default.
- **2025-11-26 Progress**: Started carving the file into targeted partials by moving all bounds/rect/camera helpers into `UnityExtensions.Bounds.cs`. This includes center-point helpers, Rect‚ÜîBounds conversions, RectTransform world rects, orthographic camera bounds, and the `BoundsInt`/`Bounds` aggregation utilities, reducing the root file by ~200 lines and isolating pooling dependencies. Followed up by extracting the UI helpers (`Slider.SetColors`, RectTransform offset setters) into `UnityExtensions.UI.cs`, and physics/collider helpers (`Rigidbody2D.Stop`, `Collider2D.IsCircleFullyContained`, `PolygonCollider2D.Invert`) into `UnityExtensions.Physics.cs`, keeping IMGUI and physics logic out of the geometry-heavy root. Remaining work: move the overlap/containment predicates and grid enumeration helpers into their own partial.
- **2025-11-27 Progress**: Finished isolating the overlap/containment predicates by leaving `UnityExtensions.Containment.cs` focused solely on fast `Bounds`/`BoundsInt` predicates and extracted the grid traversal helpers (`WithPadding`, `AllFastPositionsWithin`, `IsOnEdge2D`, etc.) into the new `UnityExtensions.GridTraversal.cs` partial. This removes the last of the grid enumeration logic from the containment block and keeps grid iteration utilities discoverable alongside other discrete-grid APIs.
- **2025-11-27 Progress (cont.)**: Split the monolithic `UnityExtensions.Grid.cs` into `UnityExtensions.GridConvexHull.cs` (all builders + pooled helpers) and `UnityExtensions.GridHullDiagnostics.cs` (Vector2/FastVector3Int containment + orientation helpers), and relocated the Vector2 concave entry points into `UnityExtensions.GridConcaveHull.cs`. This keeps convex builders, diagnostics, and concave wrappers isolated so edits no longer collide.
- **2025-11-28 Progress**: Split the original 80 KB `UnityExtensions.GridConcaveHull.cs` into four targeted partials: `GridConcaveHullKnn` (k-NN builders + helper sorts), `GridConcaveHullEdgeSplit` (edge-split + Vector2 variants), `GridConcaveHullDiagnostics` (axis-corner repair, point-in-hull, geometry helpers), and `GridConcaveHullLineDivision` (legacy line-divider). The dispatcher `GridConcaveHull.cs` now only routes strategies, eliminating the previous merge hotspot.
- **2025-11-28 Progress (cont.)**: Retired the unstable line-division strategy by stubbing `BuildConcaveHull` with a `NotSupportedException` and new `[Obsolete]` attribute, and added regression tests for the diagnostics helpers (`IsPositionInside` for both Vector2 and grid variants) to guard the newly split partial boundaries.
- **2025-11-28 Progress (cont. 2)**: Added explicit edge-split regression tests that verify the algorithm falls back to the convex hull when the angle threshold is small, reintroduces concave elbows when the threshold is generous, and now also guard against `bucketSize` starvation (small bucket sizes vs generous ones).
- **Next Step**: Monitor downstream packages for lingering references to the now-obsolete line-division entry point; once usage drops to zero, remove the stub entirely (plus README/docs notes) and announce the breaking change in the changelog.
- **Impact**: Smaller diffs, easier reviews, clearer ownership of complex helpers, and fewer merge conflicts when multiple teams touch `UnityExtensions`.

### 8. Concave Hull Parity & Regression Guardrails *(In Progress)*

- **Problem**: The grid and gridless concave hull entry points had drifted apart. Edge-split builds occasionally dropped interior ‚Äúelbow‚Äù vertices (staircase/horseshoe/serpentine shapes) while the gridless FastVector path stayed sparse but inconsistent. Tight angle thresholds needed to fall back to the convex hull, yet loose thresholds and k-NN builds must retain axis corners. Randomized regression suites (`UnityExtensionsComprehensiveTests`) failed as the implementations diverged.
- **2025-11-27 Progress**: Added a shared axis-corner repair pass that can reinsert missing concave vertices using only the original input samples, deduplicates the resulting hull, and is gated so strict edge-split configurations stay convex while k-NN / high-angle builds regain their elbows. Added diagnostic/data-driven tests in `UnityExtensionsGridConcaveHullTests` plus changelog notes documenting the behavior change.
- **2025-11-28 Progress**: Extended the randomized grid + gridless regression harnesses with `HullRegressionRecorder`, capturing per-seed hull snapshots and dumping JSON diagnostics whenever an invariant fails (convex containment, duplicate detection, etc.), so future regressions come with ready-made repro assets.
- **2025-11-28 Progress (cont.)**: Introduced `ConcaveHullRepairStats` plus large-sample tests to ensure the axis-corner repair never exceeds the source point budget, and ported the axis-corner diagnostics to the gridless (`Vector2`/FastVector) suites so both entry points now log actionable data when elbows disappear.
- **2025-11-28 Progress (cont. 3)**: Hooked `ConcaveHullRepairStats` into the performance suite (see `ConcaveHullPerformanceTests.BuildConcaveHullEdgeSplitRepairStatsStayBounded`), so ‚â•10k point runs now assert bounded repair behaviour and log stats for CI dashboards.
- **Next Steps**:
  1. Aggregate the emitted repair stats in CI perf dashboards (averages, min/max) so regressions show up in build artifacts.
- **Impact**: Keeps grid and gridless concave hulls behaviorally aligned, prevents sparse concave inputs from regressing, and provides reproducible diagnostics when random-cloud suites fail.
