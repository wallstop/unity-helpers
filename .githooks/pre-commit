#!/usr/bin/env sh
set -e

# 0) Ensure .NET tools available (for CSharpier)
if command -v dotnet >/dev/null 2>&1; then
  dotnet tool restore >/dev/null 2>&1 || true
fi

# 1) Lint Markdown link text style (via Node wrapper -> PowerShell script)
if command -v node >/dev/null 2>&1; then
  node ./scripts/run-doc-link-lint.js
else
  run_pwsh() {
    pwsh -NoProfile -File scripts/lint-doc-links.ps1
  }

  run_windows_ps() {
    powershell -NoProfile -ExecutionPolicy Bypass -File scripts/lint-doc-links.ps1
  }

  if command -v pwsh >/dev/null 2>&1; then
    run_pwsh
  elif command -v powershell >/dev/null 2>&1; then
    run_windows_ps
  else
    echo "PowerShell not found. Please install Node.js (preferred) or pwsh/powershell to run docs linter." >&2
    exit 1
  fi
fi

# 2) Format staged Markdown/JSON/YAML with Prettier and re-stage
if ! command -v npx >/dev/null 2>&1; then
  echo "npx is required for formatting. Please install Node.js." >&2
  exit 1
fi

STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

# Collect file lists
MD_FILES=$(echo "$STAGED_FILES" | grep -E '\\.(md|markdown)$' || true)
JSON_FILES=$(echo "$STAGED_FILES" | grep -E '\\.(json|asmdef|asmref)$' || true)
YAML_FILES=$(echo "$STAGED_FILES" | grep -E '\\.(yml|yaml)$' || true)

# Prettier format and re-add
if [ -n "$MD_FILES" ]; then
  echo "$MD_FILES" | xargs npx --no-install prettier --write --log-level warn
  echo "$MD_FILES" | xargs git add
fi

if [ -n "$JSON_FILES" ]; then
  echo "$JSON_FILES" | xargs npx --no-install prettier --write --log-level warn
  echo "$JSON_FILES" | xargs git add
fi

if [ -n "$YAML_FILES" ]; then
  echo "$YAML_FILES" | xargs npx --no-install prettier --write --log-level warn
  echo "$YAML_FILES" | xargs git add
fi

# 3) Format staged C# files with CSharpier (if available) and re-stage
CS_FILES=$(echo "$STAGED_FILES" | grep -E '\\.cs$' || true)
if [ -n "$CS_FILES" ]; then
  if command -v pwsh >/dev/null 2>&1; then
    pwsh -NoProfile -File scripts/format-staged-csharp.ps1
  elif command -v powershell >/dev/null 2>&1; then
    powershell -NoProfile -ExecutionPolicy Bypass -File scripts/format-staged-csharp.ps1
  else
    echo "PowerShell not found. Skipping CSharpier formatting." >&2
  fi
fi

# 4) Markdown lint for staged Markdown files
if [ -n "$MD_FILES" ]; then
  npx --no-install markdownlint $MD_FILES --config .markdownlint.json --ignore-path .markdownlintignore
fi

# 5) Optional YAML lint on staged YAML (if yamllint present)
if [ -n "$YAML_FILES" ]; then
  if command -v yamllint >/dev/null 2>&1; then
    echo "$YAML_FILES" | xargs yamllint -c .yamllint.yaml
  fi
fi

