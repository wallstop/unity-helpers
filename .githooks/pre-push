#!/usr/bin/env sh
set -e

# Mirror key CI checks before pushing
# Auto-fix formatting issues where possible, then verify.
# CI will catch any issues that slip through.

# Ensure Node is available
if ! command -v npx >/dev/null 2>&1; then
  echo "npx not found; skipping Node-based checks. CI will validate." >&2
else
  # Check if npm dependencies are installed
  if [ ! -d "node_modules" ]; then
    echo "node_modules not found. Run 'npm install' to enable local pre-push checks, or skip - CI will validate." >&2
  else
    # 1) Prettier checks (Markdown, JSON, asmdef/asmref, YAML, JS)
    # Auto-fix first, then verify. If verification fails, the user needs to commit the fixes.
    if npx --no-install prettier --version >/dev/null 2>&1; then
      echo "Checking formatting..."
      if ! npx --no-install prettier --check "**/*.{md,markdown,json,asmdef,asmref,yml,yaml,js}" 2>/dev/null; then
        echo ""
        echo "=== Prettier formatting issues detected ==="
        echo "Auto-fixing formatting..."
        npx --no-install prettier --write "**/*.{md,markdown,json,asmdef,asmref,yml,yaml,js}" --log-level warn
        echo ""
        echo "Files have been auto-formatted. Please:"
        echo "  1. Review the changes: git diff"
        echo "  2. Stage and commit: git add -A && git commit --amend --no-edit"
        echo "  3. Push again: git push"
        echo ""
        exit 1
      fi
    else
      echo "prettier not installed; skipping format check. Run 'npm install' or CI will validate." >&2
    fi

    # 2) Markdownlint (uses repo config and ignore list)
    if npx --no-install markdownlint --version >/dev/null 2>&1; then
      npx --no-install markdownlint "**/*.md" "**/*.markdown" --config .markdownlint.json --ignore-path .markdownlintignore || exit 1
    else
      echo "markdownlint not installed; skipping markdown lint. Run 'npm install' or CI will validate." >&2
    fi

    # 3) Spell checking (cspell - validates all files for spelling errors)
    if npx --no-install cspell --version >/dev/null 2>&1; then
      echo "Checking spelling..."
      if ! npm run lint:spelling 2>/dev/null; then
        echo ""
        echo "=== Spelling errors detected ==="
        echo "To fix spelling issues:"
        echo "  1. Fix the typos in the reported files"
        echo "  2. Or add valid words to cspell.json in the 'words' array"
        echo "  3. Stage and commit your changes"
        echo "  4. Push again: git push"
        echo ""
        exit 1
      fi
    else
      echo "cspell not installed; skipping spell check. Run 'npm install' or CI will validate." >&2
    fi

    # 4) Doc link lint (validates internal links, relative prefixes, and broken references)
    # This runs the same PowerShell linter as the CI to catch issues before push
    echo "Checking documentation links..."
    node ./scripts/run-doc-link-lint.js || exit 1
  fi
fi

# EOL policy (CRLF, no UTF-8 BOM) - auto-fix then verify
if command -v pwsh >/dev/null 2>&1; then
  pwsh -NoProfile -File scripts/normalize-eol.ps1
  pwsh -NoProfile -File scripts/check-eol.ps1 -VerboseOutput
elif command -v powershell >/dev/null 2>&1; then
  powershell -NoProfile -ExecutionPolicy Bypass -File scripts/normalize-eol.ps1
  powershell -NoProfile -ExecutionPolicy Bypass -File scripts/check-eol.ps1 -VerboseOutput
else
  echo "PowerShell not found; skipping EOL validation." >&2
fi

# Optional YAML lint (if yamllint installed)
if command -v yamllint >/dev/null 2>&1; then
  yamllint -c .yamllint.yaml .
else
  echo "yamllint not found; skipping YAML lint. CI will catch issues." >&2
fi

# Optional external link check (if lychee installed)
if command -v lychee >/dev/null 2>&1; then
  # Exclude node_modules to avoid scanning hundreds of third-party markdown files
  lychee -c .lychee.toml --no-progress --verbose --exclude-path node_modules --exclude-path .git "**/*.md"
else
  echo "lychee not found; skipping external link check. CI will run lychee." >&2
fi

# Test lifecycle lint
if command -v pwsh >/dev/null 2>&1; then
  pwsh -NoProfile -File scripts/lint-tests.ps1 -VerboseOutput
elif command -v powershell >/dev/null 2>&1; then
  powershell -NoProfile -ExecutionPolicy Bypass -File scripts/lint-tests.ps1 -VerboseOutput
else
  echo  'PowerShell not found; skipping test lints.' >&2 
fi
