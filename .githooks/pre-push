#!/usr/bin/env sh
set -e

# ============================================================================
# PRE-PUSH HOOK: Mirror CI checks before pushing
# ============================================================================
# This hook runs the same checks as CI to catch issues before they reach
# the remote. Auto-fixes formatting issues where possible, then verifies.
#
# Checks performed:
#   1. Prettier formatting (Markdown, JSON, asmdef/asmref, YAML, JS)
#   2. Markdownlint
#   3. Spell checking (cspell)
#   4. Doc link lint
#   5. EOL normalization and verification
#   6. yamllint (if installed)
#   7. actionlint (if installed and workflow files changed)
#   8. External link check with lychee (if installed)
#   9. Test lifecycle lint
#
# LINE ENDING NOTE:
#   This repo uses CRLF for most files (.gitattributes).
#   EXCEPTIONS that MUST use LF:
#     - YAML files (.yml, .yaml) - cross-platform compatibility
#     - Shell scripts (.sh) - Unix requirement
#     - .github/** ALL files - GitHub Actions run on Linux, Dependabot commits LF
#       This includes .github/*.md files (copilot-instructions.md, etc.)
#   If you encounter EOL-related CI failures, run: npm run fix:eol
# ============================================================================

# Ensure Node is available
if ! command -v npx >/dev/null 2>&1; then
  echo "npx not found; skipping Node-based checks. CI will validate." >&2
else
  # Check if npm dependencies are installed
  if [ ! -d "node_modules" ]; then
    echo "node_modules not found. Run 'npm install' to enable local pre-push checks, or skip - CI will validate." >&2
  else
    # 1) Prettier checks (Markdown, JSON, asmdef/asmref, YAML, JS)
    # File patterns match CI workflows:
    #   - markdown-json.yml: **/*.{md,markdown} and **/*.{json,asmdef,asmref}
    #   - yaml-format-lint.yml: **/*.{yml,yaml}
    # Auto-fix first, then verify. If verification fails, the user needs to commit the fixes.
    if npx --no-install prettier --version >/dev/null 2>&1; then
      echo "Checking formatting with patterns matching CI..."
      echo "  Patterns: **/*.{md,markdown,json,asmdef,asmref,yml,yaml,js}"
      if ! npx --no-install prettier --check "**/*.{md,markdown,json,asmdef,asmref,yml,yaml,js}" 2>/dev/null; then
        echo ""
        echo "=== Prettier formatting issues detected ==="
        echo "Auto-fixing formatting..."
        npx --no-install prettier --write "**/*.{md,markdown,json,asmdef,asmref,yml,yaml,js}" --log-level warn
        echo ""
        echo "Files have been auto-formatted. Please:"
        echo "  1. Review the changes: git diff"
        echo "  2. Stage and commit: git add -A && git commit --amend --no-edit"
        echo "  3. Push again: git push"
        echo ""
        exit 1
      fi
      echo "✓ Prettier formatting OK"
    else
      echo "prettier not installed; skipping format check. Run 'npm install' or CI will validate." >&2
    fi

    # 2) Markdownlint (uses repo config and ignore list)
    if npx --no-install markdownlint --version >/dev/null 2>&1; then
      npx --no-install markdownlint "**/*.md" "**/*.markdown" --config .markdownlint.json --ignore-path .markdownlintignore || exit 1
    else
      echo "markdownlint not installed; skipping markdown lint. Run 'npm install' or CI will validate." >&2
    fi

    # 3) Spell checking (cspell - validates all files for spelling errors)
    if npx --no-install cspell --version >/dev/null 2>&1; then
      echo "Checking spelling..."
      if ! npm run lint:spelling 2>/dev/null; then
        echo ""
        echo "=== Spelling errors detected ==="
        echo "To fix spelling issues:"
        echo "  1. Fix the typos in the reported files"
        echo "  2. Or add valid words to cspell.json in the 'words' array"
        echo "  3. Stage and commit your changes"
        echo "  4. Push again: git push"
        echo ""
        exit 1
      fi
      echo "✓ Spell check OK"
    else
      echo "cspell not installed; skipping spell check. Run 'npm install' or CI will validate." >&2
    fi

    # 4) Doc link lint (validates internal links, relative prefixes, and broken references)
    # This runs the same PowerShell linter as the CI to catch issues before push
    echo "Checking documentation links..."
    node ./scripts/run-doc-link-lint.js || exit 1
    echo "✓ Doc links OK"
  fi
fi

# EOL policy (CRLF for most, LF for YAML/shell) - auto-fix then verify
if command -v pwsh >/dev/null 2>&1; then
  pwsh -NoProfile -File scripts/normalize-eol.ps1
  pwsh -NoProfile -File scripts/check-eol.ps1 -VerboseOutput
elif command -v powershell >/dev/null 2>&1; then
  powershell -NoProfile -ExecutionPolicy Bypass -File scripts/normalize-eol.ps1
  powershell -NoProfile -ExecutionPolicy Bypass -File scripts/check-eol.ps1 -VerboseOutput
else
  echo "PowerShell not found; skipping EOL validation." >&2
fi

# Optional YAML lint (if yamllint installed)
if command -v yamllint >/dev/null 2>&1; then
  echo "Running yamllint..."
  yamllint -c .yamllint.yaml .
  echo "✓ yamllint OK"
else
  echo "yamllint not found; skipping YAML lint. CI will catch issues." >&2
fi

# Optional external link check (if lychee installed)
if command -v lychee >/dev/null 2>&1; then
  # Exclude node_modules to avoid scanning hundreds of third-party markdown files
  lychee -c .lychee.toml --no-progress --verbose --exclude-path node_modules --exclude-path .git "**/*.md"
else
  echo "lychee not found; skipping external link check. CI will run lychee." >&2
fi

# Test lifecycle lint (UNH001-UNH003: lifecycle, UNH004: naming conventions)
if command -v pwsh >/dev/null 2>&1; then
  pwsh -NoProfile -File scripts/lint-tests.ps1 -VerboseOutput || {
    echo ""
    echo "=== Test lint failed ==="
    echo "Fix the issues above or add // UNH-SUPPRESS comments for valid exceptions."
    echo "For naming convention errors (UNH004):"
    echo "  - Use PascalCase or dot notation in TestName/SetName (e.g., 'Input.Null.ReturnsFalse')"
    echo "  - Use PascalCase for TestCaseSource method names (e.g., 'EdgeCaseTestData')"
    echo ""
    exit 1
  }
elif command -v powershell >/dev/null 2>&1; then
  powershell -NoProfile -ExecutionPolicy Bypass -File scripts/lint-tests.ps1 -VerboseOutput || {
    echo ""
    echo "=== Test lint failed ==="
    echo "Fix the issues above or add // UNH-SUPPRESS comments for valid exceptions."
    echo "For naming convention errors (UNH004):"
    echo "  - Use PascalCase or dot notation in TestName/SetName (e.g., 'Input.Null.ReturnsFalse')"
    echo "  - Use PascalCase for TestCaseSource method names (e.g., 'EdgeCaseTestData')"
    echo ""
    exit 1
  }
else
  echo 'PowerShell not found; skipping test lints.' >&2
fi

# Wiki generation tests (validates sidebar format, link transformations)
# This mirrors the validate-wiki-links.yml CI workflow
WIKI_CHANGES=$(git diff --name-only @{upstream}..HEAD 2>/dev/null | grep -E '^(scripts/wiki/|scripts/tests/test-wiki-generation\.sh|\.github/workflows/deploy-wiki\.yml)' || true)
if [ -z "$WIKI_CHANGES" ]; then
  # Also check staged/uncommitted wiki-related changes
  WIKI_CHANGES=$(git diff --name-only HEAD 2>/dev/null | grep -E '^(scripts/wiki/|scripts/tests/test-wiki-generation\.sh|\.github/workflows/deploy-wiki\.yml)' || true)
fi

if [ -n "$WIKI_CHANGES" ]; then
  echo "Wiki-related files changed:"
  echo "$WIKI_CHANGES" | sed 's/^/  /'
  echo "Running wiki generation tests..."
  if ! bash scripts/tests/test-wiki-generation.sh; then
    echo ""
    echo "=== Wiki generation tests failed ==="
    echo "Fix the issues in scripts/wiki/*.py or scripts/tests/test-wiki-generation.sh"
    echo ""
    exit 1
  fi
  echo "✓ Wiki generation tests OK"
  
  # Also run Python wiki tests if pytest is available
  if command -v python3 >/dev/null 2>&1 && python3 -c "import pytest" 2>/dev/null; then
    echo "Running Python wiki script tests..."
    if ! python3 -m pytest scripts/wiki/test_wiki_scripts.py -v; then
      echo ""
      echo "=== Python wiki tests failed ==="
      echo "Fix the issues in scripts/wiki/*.py"
      echo ""
      exit 1
    fi
    echo "✓ Python wiki tests OK"
  else
    echo "pytest not installed; skipping Python wiki tests. CI will run them." >&2
  fi
fi

# actionlint check for GitHub Actions workflows (only if workflow files changed)
# This mirrors the actionlint.yml CI workflow
# Use @{upstream} to compare against the remote tracking branch
WORKFLOW_CHANGES=$(git diff --name-only @{upstream}..HEAD 2>/dev/null | grep -E '^\.github/workflows/' || true)
if [ -z "$WORKFLOW_CHANGES" ]; then
  # Also check staged/uncommitted workflow changes
  WORKFLOW_CHANGES=$(git diff --name-only HEAD 2>/dev/null | grep -E '^\.github/workflows/' || true)
fi

if [ -n "$WORKFLOW_CHANGES" ]; then
  echo "GitHub Actions workflow files changed:"
  echo "$WORKFLOW_CHANGES" | sed 's/^/  /'
  if command -v actionlint >/dev/null 2>&1; then
    echo "Running actionlint..."
    if ! actionlint; then
      echo ""
      echo "=== actionlint found issues ==="
      echo "Fix the workflow issues before pushing."
      echo ""
      exit 1
    fi
    echo "✓ actionlint OK"
  else
    echo "actionlint not installed; skipping workflow lint." >&2
    echo "Install: go install github.com/rhysd/actionlint/cmd/actionlint@latest" >&2
    echo "CI will run actionlint and catch any issues." >&2
  fi
fi

# ============================================================================
# FINAL VERIFICATION SUMMARY
# ============================================================================
echo ""
echo "Pre-push checks complete. Push proceeding..."
