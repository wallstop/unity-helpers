name: Validate Documentation

on:
  push:
    branches:
      - main
    paths:
      - "docs/**"
      - "*.md"
      - "_config.yml"
      - "assets/**"
  pull_request:
    paths:
      - "docs/**"
      - "*.md"
      - "_config.yml"
      - "assets/**"
  workflow_dispatch:

jobs:
  validate-links:
    name: Validate Internal Links
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check internal markdown links exist
        run: |
          #!/bin/bash
          set -euo pipefail

          echo "üîç Validating that internal markdown links point to existing files..."

          errors=0
          
          # Find all markdown files
          while IFS= read -r -d '' mdfile; do
            dir=$(dirname "$mdfile")
            
            # Extract markdown links: [text](link)
            # Filter to only internal links (not http, https, #, mailto)
            grep -oP '\]\(\K[^)]+(?=\))' "$mdfile" 2>/dev/null | while read -r link; do
              # Skip external links, anchors, and mailto
              if [[ "$link" =~ ^https?:// ]] || [[ "$link" =~ ^# ]] || [[ "$link" =~ ^mailto: ]]; then
                continue
              fi
              
              # Remove anchor from link if present
              link_without_anchor="${link%%#*}"
              
              # Skip if empty (was just an anchor)
              if [[ -z "$link_without_anchor" ]]; then
                continue
              fi
              
              # Resolve the link path relative to the markdown file's directory
              if [[ "$link_without_anchor" == /* ]]; then
                # Absolute path from repo root
                target_path=".${link_without_anchor}"
              else
                # Relative path
                target_path="$dir/$link_without_anchor"
              fi
              
              # Normalize the path
              target_path=$(realpath -m "$target_path" 2>/dev/null || echo "$target_path")
              
              # Check if target exists
              if [[ ! -e "$target_path" ]]; then
                echo "‚ùå Broken link in $mdfile: $link -> $target_path (file not found)"
                errors=$((errors + 1))
              fi
            done
          done < <(find . -name "*.md" -type f -not -path "./node_modules/*" -print0)

          if [[ $errors -gt 0 ]]; then
            echo ""
            echo "‚ùå Found $errors broken internal link(s)"
            exit 1
          fi
          
          echo "‚úÖ All internal links are valid"

  validate-link-format:
    name: Validate Link Format
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check markdown link format
        run: |
          #!/bin/bash
          set -euo pipefail

          echo "üîç Checking that internal markdown links use proper relative format (./ or ../)..."

          # Find links that don't start with ./, ../, http, https, #, or mailto
          # These are internal links that should have a relative prefix
          
          # Pattern explanation:
          # - \]\( - matches ](
          # - [^).]+ - matches characters that aren't ) or . (to exclude ./ and ../)
          # - We then filter to exclude http, #, mailto, and links starting with ./
          
          violations=$(grep -rn --include="*.md" -E '\]\([^)]+\)' . \
            --exclude-dir=node_modules \
            2>/dev/null | \
            grep -vE '\]\(\.\./|\]\(\./|\]\(https?://|\]\(#|\]\(mailto:' | \
            grep -E '\]\([a-zA-Z]' || true)

          if [[ -n "$violations" ]]; then
            echo "‚ùå Found markdown links missing relative prefix (./ or ../):"
            echo ""
            echo "$violations"
            echo ""
            echo "Links to local files should use relative paths like:"
            echo "  - Use ./file format instead of bare file"
            echo "  - Use ./docs/file format instead of docs/file"
            echo ""
            exit 1
          fi

          echo "‚úÖ All internal links use proper relative format"

  build-jekyll-test:
    name: Build Jekyll Site
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: "3.2"
          bundler-cache: true

      - name: Install dependencies
        run: |
          if [[ -f Gemfile ]]; then
            bundle install
          else
            gem install jekyll bundler
          fi

      - name: Build Jekyll site
        run: |
          if [[ -f Gemfile ]]; then
            bundle exec jekyll build --strict_front_matter
          else
            jekyll build --strict_front_matter
          fi
        env:
          JEKYLL_ENV: production

      - name: Verify build output
        run: |
          if [[ -d "_site" ]]; then
            echo "‚úÖ Jekyll site built successfully"
            echo "üìÅ Site contents:"
            find _site -type f | head -20
          else
            echo "‚ùå Jekyll build did not produce _site directory"
            exit 1
          fi
