name: Documentation Code Sample Validation

on:
  push:
    branches:
      - main
    paths:
      - "**/*.md"
      - "scripts/extract-code-samples.js"
      - ".github/workflows/doc-code-samples.yml"
  pull_request:
    paths:
      - "**/*.md"
      - "scripts/extract-code-samples.js"
      - ".github/workflows/doc-code-samples.yml"

permissions:
  contents: read

jobs:
  validate-code-samples:
    name: Validate Code Samples
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6.0.1

      - name: Setup Node.js
        uses: actions/setup-node@v6.1.0
        with:
          node-version: "22"
          cache: "npm"
          cache-dependency-path: package.json

      - name: Extract code samples
        id: extract
        run: |
          node scripts/extract-code-samples.js --verbose --extract-only

          # Check for extraction errors
          if [ ! -f artifacts/code-samples/extraction-report.json ]; then
            echo "‚ùå Failed to generate extraction report"
            exit 1
          fi

      - name: Validate code sample syntax
        run: |
          echo "üîç Checking code samples for common syntax issues..."

          # Check for unbalanced braces in extracted samples
          ISSUES_FOUND=0

          if [ -d artifacts/code-samples ]; then
            for file in artifacts/code-samples/*.cs; do
              if [ -f "$file" ]; then
                # Count opening and closing braces
                OPEN_BRACES=$(grep -o '{' "$file" 2>/dev/null | wc -l)
                CLOSE_BRACES=$(grep -o '}' "$file" 2>/dev/null | wc -l)

                if [ "$OPEN_BRACES" != "$CLOSE_BRACES" ]; then
                  echo "‚ö†Ô∏è Unbalanced braces in $(basename "$file"): { = $OPEN_BRACES, } = $CLOSE_BRACES"
                  ISSUES_FOUND=$((ISSUES_FOUND + 1))
                fi

                # Check for unclosed strings (odd number of quotes on a line)
                # Read file content into a temporary variable to avoid SC2094
                file_content=$(cat "$file")
                while IFS= read -r line; do
                  QUOTES=$(echo "$line" | grep -o '"' | wc -l)
                  if [ $((QUOTES % 2)) -ne 0 ]; then
                    # Skip lines with escaped quotes or string interpolation
                    if ! echo "$line" | grep -q '\"' && ! echo "$line" | grep -q '\$"'; then
                      echo "‚ö†Ô∏è Possible unclosed string in $(basename "$file")"
                      ISSUES_FOUND=$((ISSUES_FOUND + 1))
                      break
                    fi
                  fi
                done <<< "$file_content"
              fi
            done
          fi

          if [ "$ISSUES_FOUND" -gt 0 ]; then
            echo ""
            echo "‚ùå Found $ISSUES_FOUND syntax issues in code samples"
            echo "Please fix the code samples in your documentation"
            exit 1
          else
            echo "‚úÖ No obvious syntax issues found"
          fi

      - name: Upload extraction report
        uses: actions/upload-artifact@v4
        with:
          name: code-sample-report
          path: artifacts/code-samples/extraction-report.json
          retention-days: 30

      - name: Generate Summary
        run: |
          {
            echo "## üìä Code Sample Extraction Report"
            echo ""
            if [ -f artifacts/code-samples/extraction-report.json ]; then
              TOTAL=$(jq '.totalSamples' artifacts/code-samples/extraction-report.json)
              COMPLETE=$(jq '.completeSamples' artifacts/code-samples/extraction-report.json)
              PARTIAL=$(jq '.partialSamples' artifacts/code-samples/extraction-report.json)
              FILES=$(jq '.totalFiles' artifacts/code-samples/extraction-report.json)
              echo "| Metric | Count |"
              echo "|--------|-------|"
              echo "| Markdown files scanned | $FILES |"
              echo "| Total C# samples | $TOTAL |"
              echo "| Complete samples | $COMPLETE |"
              echo "| Partial/snippet samples | $PARTIAL |"
              echo ""
              echo "‚úÖ Code sample extraction completed successfully"
            else
              echo "‚ö†Ô∏è No extraction report found."
            fi
          } >> "$GITHUB_STEP_SUMMARY"
