name: Deploy Documentation to GitHub Wiki

"on":
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      force_sync:
        description: "Force sync even if no changes detected"
        required: false
        default: "false"
        type: boolean
      dry_run:
        description: "Dry run - show changes without pushing"
        required: false
        default: "false"
        type: boolean

permissions:
  contents: write

# Prevent concurrent wiki pushes to avoid git conflicts
concurrency:
  group: wiki-sync
  cancel-in-progress: false

env:
  WIKI_URL: "https://github.com/${{ github.repository }}.wiki.git"

jobs:
  # First job: Check if wiki exists before attempting sync
  check-wiki:
    name: Check wiki availability
    runs-on: ubuntu-latest
    outputs:
      wiki_exists: ${{ steps.check.outputs.wiki_exists }}
    steps:
      - name: Check if wiki repository exists
        id: check
        run: |
          set -euo pipefail
          echo "Checking wiki availability at: $WIKI_URL"

          # Use git ls-remote for lightweight check (no clone needed)
          if git ls-remote "$WIKI_URL" HEAD >/dev/null 2>&1; then
            echo "âœ… Wiki repository exists"
            echo "wiki_exists=true" >> "$GITHUB_OUTPUT"
          else
            echo "::warning::Wiki repository not found at $WIKI_URL"
            echo "::warning::To enable wiki sync:"
            echo "::warning::  1. Go to repository Settings â†’ Features"
            echo "::warning::  2. Enable 'Wikis'"
            echo "::warning::  3. Create at least one wiki page manually"
            echo "::warning::  4. Re-run this workflow"
            echo "wiki_exists=false" >> "$GITHUB_OUTPUT"
          fi

  # Second job: Sync documentation to wiki (only if wiki exists)
  sync-wiki:
    name: Sync documentation to wiki
    needs: check-wiki
    if: needs.check-wiki.outputs.wiki_exists == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout main repository
        uses: actions/checkout@v4
        with:
          path: main
          fetch-depth: 1

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Clone wiki repository
        id: clone-wiki
        run: |
          set -euo pipefail
          echo "Cloning wiki repository..."

          WIKI_AUTH_URL="https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.wiki.git"

          if ! git clone "$WIKI_AUTH_URL" wiki 2>&1; then
            echo "::error::Failed to clone wiki repository"
            echo "::error::Ensure the wiki has been initialized with at least one page"
            exit 1
          fi

          echo "âœ… Successfully cloned wiki repository"

          # Detect wiki branch
          cd wiki
          WIKI_BRANCH=$(git rev-parse --abbrev-ref HEAD)
          echo "wiki_branch=$WIKI_BRANCH" >> "$GITHUB_OUTPUT"
          echo "Wiki branch: $WIKI_BRANCH"

      - name: Prepare wiki content
        id: prepare
        run: |
          set -euo pipefail

          # Clear existing wiki content (except .git)
          echo "Clearing existing wiki content..."
          find wiki -mindepth 1 -maxdepth 1 ! -name '.git' -exec rm -rf {} +

          # Run Python script to prepare wiki content
          echo "Preparing wiki content with Python scripts..."
          python main/scripts/wiki/prepare_wiki.py \
            --source main \
            --dest wiki \
            --verbose

          # Report statistics
          pages_created=$(find wiki -name "*.md" -type f | wc -l)
          images_copied=$(find wiki -type f ! -name "*.md" ! -path "wiki/.git/*" 2>/dev/null | wc -l || echo "0")

          echo "pages_created=$pages_created" >> "$GITHUB_OUTPUT"
          echo "images_copied=$images_copied" >> "$GITHUB_OUTPUT"
          echo ""
          echo "âœ… Content preparation complete"
          echo "   Pages: $pages_created"
          echo "   Images: $images_copied"

      - name: Generate sidebar
        run: |
          set -euo pipefail

          echo "Generating _Sidebar.md with Python script..."
          python main/scripts/wiki/generate_wiki_sidebar.py wiki --output wiki/_Sidebar.md

          echo "Generated sidebar content:"
          cat wiki/_Sidebar.md
          echo ""
          echo "âœ… Sidebar generated"

      - name: Generate footer
        run: |
          set -euo pipefail

          echo "Generating _Footer.md with Python script..."
          python main/scripts/wiki/generate_wiki_footer.py --output wiki/_Footer.md

          echo "âœ… Footer generated"

      - name: Validate wiki content
        run: |
          set -euo pipefail
          cd wiki

          echo "Validating wiki content..."
          errors=0
          warnings=0

          # Check for required pages
          required_pages=("Home.md" "CHANGELOG.md" "_Sidebar.md" "_Footer.md")
          for page in "${required_pages[@]}"; do
            if [ ! -f "$page" ]; then
              echo "::error::Required page missing: $page"
              errors=$((errors + 1))
            fi
          done

          # Check for empty files
          while IFS= read -r -d '' file; do
            if [ ! -s "$file" ]; then
              echo "::warning::Empty file detected: $file"
              warnings=$((warnings + 1))
            fi
          done < <(find . -name "*.md" -print0)

          # Validate sidebar links - ensure all [Display](Page) references have corresponding files
          echo ""
          echo "Validating sidebar links..."
          if [ -f "_Sidebar.md" ]; then
            # Extract all [Display](Page) patterns and check each page exists
            # Captures the part inside parentheses (the page name) from Markdown links
            # Character class includes: letters, numbers, hyphens, underscores, periods
            missing_pages=$(grep -oE '\]\([A-Za-z0-9_.-]+\)' _Sidebar.md | sed 's/\](//;s/)//' | sort -u | while read -r page; do
              [ ! -f "$page.md" ] && echo "$page"
            done || true)
            if [ -n "$missing_pages" ]; then
              echo "Missing pages referenced in sidebar:"
              echo "$missing_pages"
              # Count missing pages and add to errors
              missing_count=$(echo "$missing_pages" | grep -c . || echo "0")
              errors=$((errors + missing_count))
            fi
          fi

          # Count total pages
          total_pages=$(find . -name "*.md" -type f | wc -l)
          total_images=$(find . -type f ! -name "*.md" ! -path "./.git/*" | wc -l)

          echo ""
          echo "ðŸ“Š Wiki Statistics:"
          echo "   Total pages: $total_pages"
          echo "   Total images: $total_images"
          echo "   Errors: $errors"
          echo "   Warnings: $warnings"

          # List all generated wiki pages for debugging
          echo ""
          echo "ðŸ“„ Generated wiki pages:"
          find . -name "*.md" -type f | sort | sed 's|^\./||'

          if [ "$errors" -gt 0 ]; then
            echo "::error::Validation failed with $errors errors"
            exit 1
          fi

          echo "âœ… Validation passed"

      - name: Check for changes
        id: changes
        run: |
          set -euo pipefail
          cd wiki

          git add -A

          if git diff --staged --quiet; then
            echo "has_changes=false" >> "$GITHUB_OUTPUT"
            echo "ðŸ“‹ No changes detected in wiki content"
          else
            echo "has_changes=true" >> "$GITHUB_OUTPUT"
            echo "ðŸ“‹ Changes detected:"
            git diff --staged --stat
          fi

      - name: Commit and push to wiki
        if: steps.changes.outputs.has_changes == 'true' || github.event.inputs.force_sync == 'true'
        run: |
          set -euo pipefail
          cd wiki

          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Prepare commit message with metadata
          COMMIT_MSG="Sync documentation from main repository

          Source commit: ${{ github.sha }}
          Triggered by: ${{ github.event_name }}
          Workflow run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          # Stage all changes
          git add -A

          # Check for changes again (in case force_sync but no actual changes)
          if git diff --staged --quiet; then
            echo "::notice::No changes to commit (force_sync enabled but content identical)"
            exit 0
          fi

          # Dry run mode
          if [ "${{ github.event.inputs.dry_run }}" = "true" ]; then
            echo "ðŸ” DRY RUN MODE - Changes that would be committed:"
            git diff --staged --stat
            echo ""
            echo "Commit message would be:"
            echo "$COMMIT_MSG"
            exit 0
          fi

          # Commit changes
          git commit -m "$COMMIT_MSG"

          # Push to wiki (try detected branch first, then common alternatives)
          WIKI_BRANCH="${{ steps.clone-wiki.outputs.wiki_branch }}"
          echo "Pushing to wiki branch: $WIKI_BRANCH"

          if ! git push origin "$WIKI_BRANCH"; then
            echo "::warning::Push to $WIKI_BRANCH failed, trying alternatives..."
            if ! git push origin master 2>/dev/null; then
              if ! git push origin main 2>/dev/null; then
                echo "::error::Failed to push to wiki repository"
                exit 1
              fi
            fi
          fi

          echo ""
          echo "âœ… Successfully synced documentation to wiki"
          echo "ðŸ”— View wiki: https://github.com/${{ github.repository }}/wiki"

      - name: Summary
        if: always()
        run: |
          {
            echo "## Wiki Sync Summary"
            echo ""

            if [ "${{ needs.check-wiki.outputs.wiki_exists }}" = "false" ]; then
              echo "âš ï¸ **Wiki not available** - Please enable and initialize the wiki first."
            elif [ "${{ steps.changes.outputs.has_changes }}" = "false" ] && [ "${{ github.event.inputs.force_sync }}" != "true" ]; then
              echo "âœ… **No changes detected** - Wiki is already up to date."
            elif [ "${{ github.event.inputs.dry_run }}" = "true" ]; then
              echo "ðŸ” **Dry run completed** - No changes were pushed."
            else
              echo "âœ… **Wiki synced successfully**"
            fi

            echo ""
            echo "| Metric | Value |"
            echo "|--------|-------|"
            echo "| Trigger | \`${{ github.event_name }}\` |"
            echo "| Source Commit | \`${{ github.sha }}\` |"
            echo "| Wiki URL | [View Wiki](https://github.com/${{ github.repository }}/wiki) |"
          } >> "$GITHUB_STEP_SUMMARY"

  # Notify on failure
  notify-failure:
    name: Notify on failure
    needs: [check-wiki, sync-wiki]
    if: failure()
    runs-on: ubuntu-latest
    steps:
      - name: Create failure summary
        run: |
          {
            echo "## âŒ Wiki Sync Failed"
            echo ""
            echo "The wiki synchronization workflow failed."
            echo ""
            echo "### Troubleshooting Steps"
            echo ""
            echo "1. **Check if wiki is enabled**: Go to Settings â†’ Features â†’ Wikis"
            echo "2. **Initialize wiki**: Create at least one page manually in the wiki"
            echo "3. **Check permissions**: Ensure GITHUB_TOKEN has write access"
            echo "4. **Review logs**: Check the workflow logs for specific errors"
            echo ""
            echo "[View Workflow Run](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})"
          } >> "$GITHUB_STEP_SUMMARY"
