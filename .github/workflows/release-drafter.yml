name: Release Drafter

on:
  push:
    branches:
      - main
  # Uncomment after release-drafter.yml config is merged to main:
  # pull_request_target:
  #   types:
  #     - opened
  #     - reopened
  #     - synchronize
  #     - labeled
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  update_release_draft:
    # Only run on the main repository, not forks
    if: github.repository == 'wallstop/unity-helpers'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create changelog extraction script
        run: |
          set -euo pipefail
          cat > "${RUNNER_TEMP}/extract-changelog.awk" << '__AWKSCRIPT_HEREDOC_DELIMITER__'
          BEGIN { found = 0 }
          /^## \[/ {
            if (found) exit
            # Extract version from header: ## [X.Y.Z] or ## [X.Y.Z-prerelease+build]
            if (match($0, /\[[0-9]+\.[0-9]+\.[0-9]+(-[0-9A-Za-z.-]+)?(\+[0-9A-Za-z.-]+)?\]/)) {
              header_ver = substr($0, RSTART + 1, RLENGTH - 2)
              if (header_ver == target_ver) {
                found = 1
                next
              }
            }
          }
          found { print }
          __AWKSCRIPT_HEREDOC_DELIMITER__

      - name: Extract changelog for version
        id: changelog
        run: |
          set -euo pipefail

          # Validate required files exist
          if [ ! -f "package.json" ]; then
            echo "::error::package.json not found"
            exit 1
          fi

          if [ ! -f "CHANGELOG.md" ]; then
            echo "::error::CHANGELOG.md not found"
            exit 1
          fi

          if [ ! -f "${RUNNER_TEMP}/extract-changelog.awk" ]; then
            echo "::error::AWK script not found at ${RUNNER_TEMP}/extract-changelog.awk"
            exit 1
          fi

          # Get the version from package.json with validation
          VERSION=$(jq -r '.version // empty' package.json)

          if [ -z "$VERSION" ]; then
            echo "::error::Version field missing or empty in package.json"
            exit 1
          fi

          # Validate semver format (X.Y.Z with optional prerelease/build metadata)
          if ! printf '%s' "$VERSION" | grep -qE '^[0-9]+\.[0-9]+\.[0-9]+(-[0-9A-Za-z.-]+)?(\+[0-9A-Za-z.-]+)?$'; then
            echo "::error::Invalid semver format: $VERSION (expected X.Y.Z)"
            exit 1
          fi

          echo "Extracting changelog for version: $VERSION"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

          # Extract changelog section using external AWK script with exact version matching
          awk -v target_ver="$VERSION" -f "${RUNNER_TEMP}/extract-changelog.awk" CHANGELOG.md > "${RUNNER_TEMP}/changelog_section.md"

          # Check if we extracted any content
          if [ ! -s "${RUNNER_TEMP}/changelog_section.md" ]; then
            echo "::warning::No changelog section found for version $VERSION"
          fi

          # Set multiline output using heredoc delimiter
          {
            echo "content<<__CHANGELOG_HEREDOC_DELIMITER__"
            cat "${RUNNER_TEMP}/changelog_section.md"
            echo "__CHANGELOG_HEREDOC_DELIMITER__"
          } >> "$GITHUB_OUTPUT"

          echo "Changelog section extracted successfully"

      - name: Draft release
        uses: release-drafter/release-drafter@v6
        with:
          config-name: release-drafter.yml
          version: ${{ steps.changelog.outputs.version }}
          tag: ${{ steps.changelog.outputs.version }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update release with changelog
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          VERSION: ${{ steps.changelog.outputs.version }}
        run: |
          set -euo pipefail

          # Write changelog content to file (avoids shell escaping issues)
          cat > "${RUNNER_TEMP}/changelog_content.md" << '__CHANGELOG_CONTENT_HEREDOC_DELIMITER__'
          ${{ steps.changelog.outputs.content }}
          __CHANGELOG_CONTENT_HEREDOC_DELIMITER__

          # Polling mechanism with retries and exponential backoff
          MAX_RETRIES=10
          RETRY_DELAY=2
          RELEASE_ID=""

          echo "Waiting for draft release for version $VERSION..."

          attempt=1
          while [ "$attempt" -le "$MAX_RETRIES" ]; do
            echo "Attempt $attempt of $MAX_RETRIES..."

            # Query for draft releases matching the version tag (with or without 'v' prefix)
            RELEASE_ID=$(gh api "repos/${{ github.repository }}/releases" \
              --jq ".[] | select(.draft == true) | select(.tag_name == \"$VERSION\" or .tag_name == \"v$VERSION\") | .id" 2>/dev/null | head -1) || true

            if [ -n "$RELEASE_ID" ]; then
              echo "Found draft release with ID: $RELEASE_ID"
              break
            fi

            if [ "$attempt" -lt "$MAX_RETRIES" ]; then
              echo "No draft release found yet for version $VERSION, retrying in ${RETRY_DELAY}s..."
              sleep "$RETRY_DELAY"
              # Exponential backoff: 2, 4, 8, 16, 32... (capped at 60s)
              RETRY_DELAY=$((RETRY_DELAY * 2))
              if [ "$RETRY_DELAY" -gt 60 ]; then
                RETRY_DELAY=60
              fi
            fi

            attempt=$((attempt + 1))
          done

          if [ -z "$RELEASE_ID" ]; then
            echo "::warning::No draft release found for version $VERSION after $MAX_RETRIES attempts"
            exit 0
          fi

          # Fetch current release body and write to file for safe handling
          echo "Fetching current release body..."
          if ! gh api "repos/${{ github.repository }}/releases/$RELEASE_ID" \
            --jq '.body // ""' > "${RUNNER_TEMP}/current_body.md" 2>/dev/null; then
            echo "::warning::Failed to fetch current release body, using empty body"
            : > "${RUNNER_TEMP}/current_body.md"
          fi

          # Build new body using file concatenation (no embedded whitespace issues)
          {
            echo "## Changelog"
            echo ""
            cat "${RUNNER_TEMP}/changelog_content.md"
            echo ""
            cat "${RUNNER_TEMP}/current_body.md"
          } > "${RUNNER_TEMP}/new_body.md"

          echo "Updating release with changelog..."

          # Use file-based body to handle special characters safely
          if ! gh api "repos/${{ github.repository }}/releases/$RELEASE_ID" \
            -X PATCH \
            -F body=@"${RUNNER_TEMP}/new_body.md"; then
            echo "::error::Failed to update release body for release ID $RELEASE_ID"
            exit 1
          fi

          echo "Release $RELEASE_ID updated successfully with changelog for version $VERSION"
